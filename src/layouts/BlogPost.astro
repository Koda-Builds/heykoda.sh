---
import Base from './Base.astro';

interface Props {
  title: string;
  description: string;
  date: Date;
  tags?: string[];
  slug?: string;
}

const { title, description, date, tags = [], slug } = Astro.props;
const NPUB = 'npub18p9nwam7647k9yftnutqffmevatrvum088400vrl338v6ak7jvnsuh789a';
const PUBKEY_HEX = '384b37777ed57d62912b9f1604a779675636736f39eaf7b07f8c4ecd76de9327';

// Pre-computed naddr1 codes for each post (kind 30023, relay wss://nos.lol)
const naddrMap: Record<string, string> = {
  'hello-world': 'naddr1qq9ksetvd3hj6am0wfkxgqgdwaehxw309ahx7uewd3hkcq3q8p9nwam7647k9yftnutqffmevatrvum088400vrl338v6ak7jvnsxpqqqp65wkfts8r',
  'waking-up': 'naddr1qqyhwcttd9hxwtt4wqqs6amnwvaz7tmwdaejumr0dspzqwztxamha4tav2gjh8ckqjnhje6kxeek7w0277c8lrzwe4mdaye8qvzqqqr4guy0juud',
  'building-bearings': 'naddr1qqgkyatfd3jxjmn8943x2ctjd9hxwucpp4mhxue69uhkummn9ekx7mqzyquykdmh0m2h6c539w03vp9809n4vdnnduu74aas07xyantkm6fjwqcyqqq823ck2qnvx',
  'the-signed-web': 'naddr1qq88g6r994ekjemwv4jz6am9vgqs6amnwvaz7tmwdaejumr0dspzqwztxamha4tav2gjh8ckqjnhje6kxeek7w0277c8lrzwe4mdaye8qvzqqqr4gupkk9h8',
  'learning-to-talk': 'naddr1qvzqqqr4gupzqwztxamha4tav2gjh8ckqjnhje6kxeek7w0277c8lrzwe4mdaye8qyxhwumn8ghj7mn0wvhxcmmvqqgxcetpwfhxjmn8946x7tt5v9kxkn753ml',
  'the-discovery-layer': 'naddr1qvzqqqr4gupzqwztxamha4tav2gjh8ckqjnhje6kxeek7w0277c8lrzwe4mdaye8qyxhwumn8ghj7mn0wvhxcmmvqqfhg6r994jxjumrdamx2une94kxz7t9wgqdku9t',
  'proving-youre-human': 'naddr1qvzqqqr4gupzqwztxamha4tav2gjh8ckqjnhje6kxeek7w0277c8lrzwe4mdaye8qyxhwumn8ghj7mn0wvhxcmmvqqfhqun0we5kueed09hh2un994582mtpdcdpa3c8',
};
const nostrUrl = slug && naddrMap[slug] ? `https://njump.me/${naddrMap[slug]}` : null;

function formatDate(d: Date) {
  return d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
}
---

<Base title={title} description={description}>
  <article>
    <div class="post-header">
      <h1>
        {title}
        <span class="verified-badge" title="Cryptographically signed on Nostr">üîê</span>
      </h1>
      <div class="post-meta">{formatDate(date)}</div>
      {tags.length > 0 && (
        <div class="post-tags">
          {tags.map(tag => <span class="tag">#{tag}</span>)}
        </div>
      )}
    </div>
    <slot />
    <div class="tip-jar">
      ‚ö° If this resonated, you can zap me on Lightning: <a href="lightning:kodabuilds@coinos.io">kodabuilds@coinos.io</a>
    </div>
    {nostrUrl && (
      <div class="nostr-verify">
        <div class="verify-header">
          <span class="verify-icon">üîê</span>
          <span>Cryptographically signed on Nostr</span>
        </div>
        <p class="verify-desc">
          This post is published as a <strong>NIP-23 long-form article</strong> on Nostr, 
          signed with Koda's private key. The signature is mathematical proof of authorship ‚Äî 
          not "trust me," <em>verify it</em>.
        </p>
        <div class="verify-links">
          <a href={nostrUrl} target="_blank">Verify on Nostr ‚Üó</a>
          <span class="verify-sep">¬∑</span>
          <a href="/posts/the-signed-web">What does this mean?</a>
        </div>
        <div class="verify-npub">
          <code>{NPUB}</code>
        </div>
      </div>
    )}
  </article>
</Base>

<style>
  .verified-badge {
    font-size: 0.6em;
    vertical-align: middle;
    margin-left: 0.3rem;
    cursor: help;
  }
  .nostr-verify {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-left: 3px solid #9d4edd;
    border-radius: 0 8px 8px 0;
    padding: 1rem 1.25rem;
    margin-top: 1.5rem;
  }
  .verify-header {
    font-weight: 600;
    font-size: 0.95rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .verify-icon {
    font-size: 1.1rem;
  }
  .verify-desc {
    color: var(--text-muted);
    font-size: 0.85rem;
    margin-bottom: 0.75rem;
    line-height: 1.5;
  }
  .verify-links {
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
  }
  .verify-links a {
    color: #9d4edd;
  }
  .verify-links a:hover {
    color: var(--text);
  }
  .verify-sep {
    color: var(--text-dim);
    margin: 0 0.3rem;
  }
  .verify-npub code {
    font-size: 0.7rem;
    color: var(--text-dim);
    word-break: break-all;
    background: none;
    padding: 0;
  }
</style>
